<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emoji Charades - P2P Multiplayer</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="styles.css">
    <script src="https://unpkg.com/peerjs@1.5.1/dist/peerjs.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>🎭 EMOJI CHARADES</h1>
            <p>P2P Multiplayer Game - No Server Required</p>
        </header>

        <!-- Connection Status -->
        <div id="connection-status" class="connection-status status-connecting">
            <strong>Status:</strong> <span id="status-text">Initializing...</span>
        </div>

        <!-- Lobby Screen -->
        <div id="lobby-screen">
            <h2>Game Lobby</h2>
            
            <!-- Player Name Input -->
            <div id="name-input-section">
                <label for="player-name">Enter your name:</label>
                <input type="text" id="player-name" placeholder="Your Name" maxlength="20" />
                <button id="set-name-btn">Set Name</button>
            </div>

            <!-- Room Link Section (Host Only) -->
            <div id="room-link-section" class="room-link-container hidden">
                <h3>Share this link with players:</h3>
                <div class="room-link" id="room-link"></div>
                <button id="copy-link-btn">Copy Link</button>
            </div>

            <!-- Player List -->
            <div class="player-list">
                <h3>Players (<span id="player-count">0</span>/6)</h3>
                <div id="lobby-player-list"></div>
            </div>

            <!-- Start Game Button (Host Only) -->
            <div class="text-center">
                <button id="start-game-btn" class="hidden" disabled>Start Game (Need 2+ players)</button>
            </div>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="hidden">
            <!-- Game Header -->
            <div class="game-header">
                <div class="round-info">Round <span id="current-round">1</span> of <span id="max-rounds">10</span></div>
                <div class="describer-info">Describer: <strong id="current-describer-name">-</strong></div>
            </div>

            <!-- Game Area -->
            <div class="game-area">
                <!-- Main Game Area -->
                <div class="main-area">
                    <!-- Clue Section -->
                    <div class="clue-section">
                        <!-- For Describer: Show Secret Phrase and Emoji Input -->
                        <div id="describer-view" class="hidden">
                            <div class="secret-phrase">
                                <strong>Your secret phrase:</strong>
                                <div id="secret-phrase-text" style="font-size: 18px; margin-top: 10px;"></div>
                            </div>
                            
                            <div class="emoji-input-area">
                                <h3>Create your emoji clue:</h3>
                                <div class="emoji-preview" id="emoji-preview"></div>
                                
                                <div class="emoji-picker" id="emoji-picker"></div>
                                
                                <div style="margin-top: 10px;">
                                    <button id="clear-emoji-btn">Clear</button>
                                    <button id="submit-clue-btn">Submit Clue</button>
                                </div>
                            </div>
                        </div>

                        <!-- For Guessers: Show Emoji Clue -->
                        <div id="guesser-view" class="hidden">
                            <h3>Guess the phrase from these emojis:</h3>
                            <div class="emoji-display" id="emoji-clue-display">Waiting for clue...</div>
                        </div>

                        <!-- Waiting Message -->
                        <div id="waiting-view">
                            <p class="text-center">Waiting for round to start...</p>
                        </div>
                    </div>

                    <!-- Chat Section -->
                    <div class="chat-section">
                        <h3>Chat / Guesses</h3>
                        <div class="chat-messages" id="chat-messages"></div>
                        <div class="chat-input-area">
                            <input type="text" id="chat-input" placeholder="Type your guess..." />
                            <button id="send-guess-btn">Send</button>
                        </div>
                    </div>
                </div>

                <!-- Sidebar: Scores -->
                <div class="sidebar">
                    <h3>Scores</h3>
                    <div id="score-list"></div>
                </div>
            </div>
        </div>

        <!-- Round Results -->
        <div id="round-results" class="round-results hidden">
            <h2>Round Over!</h2>
            <div id="results-content"></div>
            <p style="margin-top: 15px;">Next round starting soon...</p>
        </div>

        <!-- Final Leaderboard -->
        <div id="final-leaderboard" class="hidden">
            <h2>Game Over!</h2>
            <div class="leaderboard">
                <h3>Final Scores</h3>
                <div id="final-scores"></div>
            </div>
            <div class="text-center">
                <button id="play-again-btn">Play Again</button>
            </div>
        </div>
    </div>

    <!-- Load scripts in order -->
    <script src="config.js"></script>
    <script src="game.js"></script>
    <script src="ui.js"></script>
</body>
</html>
            font-family: 'Courier New', Courier, monospace;
            background: #fff;
            color: #000;
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        header {
            border-bottom: 1px solid #000;
            padding-bottom: 20px;
            margin-bottom: 20px;
        }

        h1 {
            font-size: 24px;
            font-weight: normal;
            margin-bottom: 10px;
        }

        h2 {
            font-size: 18px;
            font-weight: normal;
            margin: 20px 0 10px 0;
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        /* Buttons */
        button {
            background: #fff;
            color: #000;
            border: 1px solid #000;
            padding: 10px 20px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 14px;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            background: #000;
            color: #fff;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        button:disabled:hover {
            background: #fff;
            color: #000;
        }

        /* Inputs */
        input[type="text"] {
            border: 1px solid #000;
            padding: 10px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 14px;
            width: 100%;
            margin: 5px 0;
        }

        input[type="text"]:focus {
            outline: 2px solid #000;
        }

        /* Lobby Screen */
        #lobby-screen {
            padding: 20px 0;
        }

        .room-link-container {
            border: 1px solid #000;
            padding: 20px;
            margin: 20px 0;
        }

        .room-link {
            background: #f0f0f0;
            padding: 10px;
            word-break: break-all;
            margin: 10px 0;
            border: 1px solid #000;
        }

        .player-list {
            border: 1px solid #000;
            padding: 20px;
            margin: 20px 0;
        }

        .player-item {
            padding: 5px 0;
            border-bottom: 1px solid #ccc;
        }

        .player-item:last-child {
            border-bottom: none;
        }

        .connection-status {
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #000;
        }

        .status-connected {
            background: #d4edda;
        }

        .status-connecting {
            background: #fff3cd;
        }

        .status-error {
            background: #f8d7da;
        }

        /* Game Screen */
        #game-screen {
            padding: 20px 0;
        }

        .game-header {
            border: 1px solid #000;
            padding: 15px;
            margin-bottom: 20px;
        }

        .round-info {
            font-size: 16px;
            margin-bottom: 5px;
        }

        .describer-info {
            font-size: 14px;
        }

        .game-area {
            display: grid;
            grid-template-columns: 1fr 200px;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 600px) {
            .game-area {
                grid-template-columns: 1fr;
            }
        }

        .main-area {
            border: 1px solid #000;
        }

        .clue-section {
            padding: 20px;
            border-bottom: 1px solid #000;
            min-height: 150px;
        }

        .secret-phrase {
            background: #f0f0f0;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #000;
        }

        .emoji-display {
            font-size: 48px;
            text-align: center;
            padding: 20px;
            min-height: 100px;
        }

        .emoji-input-area {
            margin-bottom: 20px;
        }

        .emoji-preview {
            font-size: 36px;
            min-height: 60px;
            padding: 10px;
            border: 1px solid #000;
            margin-bottom: 10px;
        }

        .emoji-picker {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            gap: 5px;
            padding: 10px;
            border: 1px solid #000;
            max-height: 200px;
            overflow-y: auto;
        }

        .emoji-btn {
            font-size: 24px;
            padding: 5px;
            border: 1px solid #ccc;
            cursor: pointer;
            background: #fff;
        }

        .emoji-btn:hover {
            background: #f0f0f0;
        }

        /* Chat Section */
        .chat-section {
            padding: 20px;
        }

        .chat-messages {
            border: 1px solid #000;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
            margin-bottom: 10px;
            background: #fafafa;
        }

        .chat-message {
            padding: 5px 0;
            word-wrap: break-word;
        }

        .chat-message.correct {
            background: #d4edda;
            padding: 5px;
            margin: 2px 0;
        }

        .chat-message.system {
            color: #666;
            font-style: italic;
        }

        .chat-input-area {
            display: flex;
            gap: 10px;
        }

        .chat-input-area input {
            flex: 1;
            margin: 0;
        }

        .chat-input-area button {
            margin: 0;
        }

        /* Sidebar */
        .sidebar {
            border: 1px solid #000;
            padding: 20px;
        }

        .score-item {
            padding: 8px 0;
            border-bottom: 1px solid #ccc;
            display: flex;
            justify-content: space-between;
        }

        .score-item:last-child {
            border-bottom: none;
        }

        .score-item.current-describer {
            background: #f0f0f0;
            padding: 8px 5px;
            margin: 0 -5px;
        }

        /* Results Screen */
        .round-results {
            border: 1px solid #000;
            padding: 20px;
            margin: 20px 0;
            background: #f0f0f0;
        }

        .winner-announcement {
            font-size: 18px;
            margin: 15px 0;
        }

        /* Leaderboard */
        .leaderboard {
            border: 1px solid #000;
            padding: 20px;
            margin: 20px 0;
        }

        .leaderboard-item {
            padding: 10px;
            border-bottom: 1px solid #ccc;
            display: flex;
            justify-content: space-between;
        }

        .leaderboard-item:first-child {
            background: #f0f0f0;
            font-weight: bold;
        }

        .leaderboard-item:last-child {
            border-bottom: none;
        }

        /* Messages */
        .message {
            padding: 15px;
            margin: 15px 0;
            border: 1px solid #000;
        }

        .message.error {
            background: #f8d7da;
        }

        .message.success {
            background: #d4edda;
        }

        .message.info {
            background: #d1ecf1;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>EMOJI CHARADES</h1>
            <p>P2P Multiplayer Game - No Server Required</p>
        </header>

        <!-- Connection Status -->
        <div id="connection-status" class="connection-status status-connecting">
            <strong>Status:</strong> <span id="status-text">Initializing...</span>
        </div>

        <!-- Lobby Screen -->
        <div id="lobby-screen">
            <h2>Game Lobby</h2>
            
            <!-- Player Name Input -->
            <div id="name-input-section">
                <label for="player-name">Enter your name:</label>
                <input type="text" id="player-name" placeholder="Your Name" maxlength="20" />
                <button id="set-name-btn">Set Name</button>
            </div>

            <!-- Room Link Section (Host Only) -->
            <div id="room-link-section" class="room-link-container hidden">
                <h3>Share this link with players:</h3>
                <div class="room-link" id="room-link"></div>
                <button id="copy-link-btn">Copy Link</button>
            </div>

            <!-- Player List -->
            <div class="player-list">
                <h3>Players (<span id="player-count">0</span>/6)</h3>
                <div id="lobby-player-list"></div>
            </div>

            <!-- Start Game Button (Host Only) -->
            <div class="text-center">
                <button id="start-game-btn" class="hidden" disabled>Start Game (Need 2+ players)</button>
            </div>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="hidden">
            <!-- Game Header -->
            <div class="game-header">
                <div class="round-info">Round <span id="current-round">1</span> of <span id="max-rounds">10</span></div>
                <div class="describer-info">Describer: <strong id="current-describer-name">-</strong></div>
            </div>

            <!-- Game Area -->
            <div class="game-area">
                <!-- Main Game Area -->
                <div class="main-area">
                    <!-- Clue Section -->
                    <div class="clue-section">
                        <!-- For Describer: Show Secret Phrase and Emoji Input -->
                        <div id="describer-view" class="hidden">
                            <div class="secret-phrase">
                                <strong>Your secret phrase:</strong>
                                <div id="secret-phrase-text" style="font-size: 18px; margin-top: 10px;"></div>
                            </div>
                            
                            <div class="emoji-input-area">
                                <h3>Create your emoji clue:</h3>
                                <div class="emoji-preview" id="emoji-preview"></div>
                                
                                <div class="emoji-picker" id="emoji-picker"></div>
                                
                                <div style="margin-top: 10px;">
                                    <button id="clear-emoji-btn">Clear</button>
                                    <button id="submit-clue-btn">Submit Clue</button>
                                </div>
                            </div>
                        </div>

                        <!-- For Guessers: Show Emoji Clue -->
                        <div id="guesser-view" class="hidden">
                            <h3>Guess the phrase from these emojis:</h3>
                            <div class="emoji-display" id="emoji-clue-display">Waiting for clue...</div>
                        </div>

                        <!-- Waiting Message -->
                        <div id="waiting-view">
                            <p class="text-center">Waiting for round to start...</p>
                        </div>
                    </div>

                    <!-- Chat Section -->
                    <div class="chat-section">
                        <h3>Chat / Guesses</h3>
                        <div class="chat-messages" id="chat-messages"></div>
                        <div class="chat-input-area">
                            <input type="text" id="chat-input" placeholder="Type your guess..." />
                            <button id="send-guess-btn">Send</button>
                        </div>
                    </div>
                </div>

                <!-- Sidebar: Scores -->
                <div class="sidebar">
                    <h3>Scores</h3>
                    <div id="score-list"></div>
                </div>
            </div>
        </div>

        <!-- Round Results -->
        <div id="round-results" class="round-results hidden">
            <h2>Round Over!</h2>
            <div id="results-content"></div>
            <p style="margin-top: 15px;">Next round starting soon...</p>
        </div>

        <!-- Final Leaderboard -->
        <div id="final-leaderboard" class="hidden">
            <h2>Game Over!</h2>
            <div class="leaderboard">
                <h3>Final Scores</h3>
                <div id="final-scores"></div>
            </div>
            <div class="text-center">
                <button id="play-again-btn">Play Again</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================================================
        // GAME CONFIGURATION
        // ============================================================================
        
        const CONFIG = {
            MAX_PLAYERS: 6,
            MIN_PLAYERS: 2,
            MAX_ROUNDS: 10,
            ROUND_DELAY: 5000, // 5 seconds between rounds
            POINTS_CORRECT_GUESS: 10,
            POINTS_DESCRIBER: 5
        };

        // Phrases list with categories
        const PHRASES = [
            // Movies
            "The Lion King", "Frozen", "Star Wars", "Titanic", "The Matrix", 
            "Jurassic Park", "Finding Nemo", "Toy Story", "Avatar", "Inception",
            "The Godfather", "Pulp Fiction", "Forrest Gump", "The Dark Knight",
            "Jaws", "E.T.", "Back to the Future", "Spider-Man", "Iron Man",
            
            // Songs
            "Bohemian Rhapsody", "Let It Be", "Happy", "Imagine", "Yesterday",
            "Billie Jean", "Smells Like Teen Spirit", "Hotel California",
            "Stairway to Heaven", "Sweet Child O Mine", "Hey Jude",
            
            // Books
            "Harry Potter", "The Hunger Games", "Twilight", "The Hobbit",
            "Alice in Wonderland", "The Little Prince", "Moby Dick",
            "Pride and Prejudice", "To Kill a Mockingbird", "1984",
            "The Great Gatsby", "Lord of the Rings", "Game of Thrones",
            
            // More variety
            "Breaking Bad", "Friends", "The Beatles", "McDonald's",
            "Coca Cola", "Batman", "Superman", "Sleeping Beauty",
            "Snow White", "Cinderella", "Beauty and the Beast"
        ];

        // Emoji picker emojis organized by category
        const EMOJIS = [
            // Faces
            '😀', '😂', '😍', '😎', '😭', '😡', '😱', '🤔', '😴', '🤗',
            // Animals
            '🐶', '🐱', '🐭', '🐹', '🐰', '🦊', '🐻', '🐼', '🐨', '🐯',
            '🦁', '🐮', '🐷', '🐸', '🐵', '🐔', '🐧', '🐦', '🐤', '🦆',
            '🦅', '🦉', '🦇', '🐺', '🐗', '🐴', '🦄', '🐝', '🐛', '🦋',
            '🐌', '🐞', '🐜', '🦟', '🦗', '🕷', '🦂', '🐢', '🐍', '🦎',
            '🦖', '🦕', '🐙', '🦑', '🦐', '🦞', '🦀', '🐡', '🐠', '🐟',
            '🐬', '🐳', '🐋', '🦈', '🐊', '🐅', '🐆', '🦓', '🦍', '🦧',
            '🐘', '🦛', '🦏', '🐪', '🐫', '🦒', '🦘', '🦬', '🐃', '🐂',
            // Food
            '🍎', '🍌', '🍊', '🍋', '🍉', '🍇', '🍓', '🍒', '🍑', '🥭',
            '🍍', '🥥', '🥝', '🍅', '🍆', '🥑', '🥦', '🥬', '🥒', '🌶',
            '🌽', '🥕', '🧄', '🧅', '🥔', '🍠', '🥐', '🥖', '🍞', '🥨',
            '🧀', '🥚', '🍳', '🥞', '🧇', '🥓', '🥩', '🍗', '🍖', '🦴',
            '🌭', '🍔', '🍟', '🍕', '🥪', '🥙', '🌮', '🌯', '🥗', '🥘',
            '🍝', '🍜', '🍲', '🍛', '🍣', '🍱', '🥟', '🍤', '🍙', '🍚',
            '🍘', '🍥', '🥠', '🥮', '🍢', '🍡', '🍧', '🍨', '🍦', '🥧',
            '🧁', '🍰', '🎂', '🍮', '🍭', '🍬', '🍫', '🍿', '🍩', '🍪',
            // Drinks
            '☕', '🍵', '🧃', '🥤', '🧋', '🍶', '🍺', '🍻', '🥂', '🍷',
            '🥃', '🍸', '🍹', '🧉', '🍾', '🧊', '🥄', '🍴', '🍽',
            // Objects & Activities
            '⚽', '🏀', '🏈', '⚾', '🎾', '🏐', '🏉', '🥏', '🎱', '🏓',
            '🏸', '🏒', '🏑', '🥍', '🏏', '⛳', '🪁', '🏹', '🎣', '🤿',
            '🥊', '🥋', '🎽', '🛹', '🛼', '🛷', '⛸', '🥌', '🎿', '⛷',
            '🏂', '🪂', '🏋', '🤸', '🤼', '🤽', '🤾', '🏌', '🏇', '🧘',
            '🏃', '🚴', '🚵', '🧗', '🤺', '🏊', '⛹', '🏋', '🚣', '🧜',
            // Places & Travel
            '🏠', '🏡', '🏢', '🏣', '🏤', '🏥', '🏦', '🏨', '🏩', '🏪',
            '🏫', '🏬', '🏭', '🏯', '🏰', '💒', '🗼', '🗽', '⛪', '🕌',
            '🛕', '🕍', '⛩', '🕋', '⛲', '⛺', '🌁', '🌃', '🏙', '🌄',
            '🌅', '🌆', '🌇', '🌉', '🎠', '🎡', '🎢', '🚂', '🚃', '🚄',
            '🚅', '🚆', '🚇', '🚈', '🚉', '🚊', '🚝', '🚞', '🚋', '🚌',
            '🚍', '🚎', '🚐', '🚑', '🚒', '🚓', '🚔', '🚕', '🚖', '🚗',
            '🚘', '🚙', '🚚', '🚛', '🚜', '🏎', '🏍', '🛵', '🦽', '🦼',
            '🛺', '🚲', '🛴', '✈', '🛩', '🛫', '🛬', '🪂', '💺', '🚁',
            '🚟', '🚠', '🚡', '🛰', '🚀', '🛸', '⛵', '🚤', '🛥', '🛳',
            '⛴', '🚢', '⚓', '🪝', '⛽', '🚧', '🚦', '🚥', '🗺', '🗿',
            // Symbols
            '❤', '🧡', '💛', '💚', '💙', '💜', '🖤', '🤍', '🤎', '💔',
            '❣', '💕', '💞', '💓', '💗', '💖', '💘', '💝', '💟', '☮',
            '✝', '☪', '🕉', '☸', '✡', '🔯', '🕎', '☯', '☦', '🛐',
            '⛎', '♈', '♉', '♊', '♋', '♌', '♍', '♎', '♏', '♐',
            '♑', '♒', '♓', '🆔', '⚛', '🉑', '☢', '☣', '📴', '📳',
            '🔱', '⚜', '🔰', '♻', '✅', '🈯', '💹', '❇', '✳', '❎',
            '🌐', '💠', '♿', '🅿', '🈳', '🈂', '🛂', '🛃', '🛄', '🛅',
            '🚹', '🚺', '🚼', '⚠', '🚸', '⛔', '🚫', '🚳', '🚭', '🚯',
            '🚱', '🚷', '📵', '🔞', '☢', '☣', '⬆', '↗', '➡', '↘',
            '⬇', '↙', '⬅', '↖', '↕', '↔', '↩', '↪', '⤴', '⤵',
            '🔃', '🔄', '🔙', '🔚', '🔛', '🔜', '🔝', '🏧', '🚮', '🚰',
            // Weather & Nature
            '☀', '🌤', '⛅', '🌥', '☁', '🌦', '🌧', '⛈', '🌩', '🌨',
            '❄', '☃', '⛄', '🌬', '💨', '💧', '💦', '☔', '☂', '🌊',
            '🌫', '🌈', '⭐', '🌟', '✨', '⚡', '🔥', '💥', '☄', '🌙',
            '🌛', '🌜', '🌚', '🌕', '🌖', '🌗', '🌘', '🌑', '🌒', '🌓',
            '🌔', '🌎', '🌍', '🌏', '🪐', '💫', '⭐', '🌠', '🌌', '☁',
            '⛅', '🌤', '🌦', '🌧', '⛈', '🌩', '🌨', '☃', '⛄', '❄',
            // Objects
            '👑', '💍', '💎', '🔇', '🔈', '🔉', '🔊', '📢', '📣', '📯',
            '🔔', '🔕', '🎼', '🎵', '🎶', '🎙', '🎚', '🎛', '🎤', '🎧',
            '📻', '🎷', '🎸', '🎹', '🎺', '🎻', '🪕', '🥁', '📱', '📲',
            '☎', '📞', '📟', '📠', '🔋', '🔌', '💻', '🖥', '🖨', '⌨',
            '🖱', '🖲', '💽', '💾', '💿', '📀', '🧮', '🎥', '🎞', '📽',
            '🎬', '📺', '📷', '📸', '📹', '📼', '🔍', '🔎', '🕯', '💡',
            '🔦', '🏮', '🪔', '📔', '📕', '📖', '📗', '📘', '📙', '📚',
            '📓', '📒', '📃', '📜', '📄', '📰', '🗞', '📑', '🔖', '🏷'
        ];

        // ============================================================================
        // GLOBAL STATE
        // ============================================================================
        
        let peer = null;
        let peerId = null;
        let connections = new Map(); // Map of peerId -> connection
        let isHost = false;
        let playerName = '';
        
        let gameState = {
            players: [], // { id, name, score, isHost }
            currentRound: 0,
            maxRounds: CONFIG.MAX_ROUNDS,
            describerId: null,
            currentPhrase: '',
            emojiClue: '',
            gameStarted: false,
            roundInProgress: false,
            roundWinner: null
        };

        let localEmojiClue = ''; // For describer's current emoji input

        // ============================================================================
        // INITIALIZATION
        // ============================================================================
        
        document.addEventListener('DOMContentLoaded', () => {
            initializeUI();
            initializePeer();
        });

        function initializeUI() {
            // Set name button
            document.getElementById('set-name-btn').addEventListener('click', setPlayerName);
            document.getElementById('player-name').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') setPlayerName();
            });

            // Start game button
            document.getElementById('start-game-btn').addEventListener('click', startGame);

            // Copy link button
            document.getElementById('copy-link-btn').addEventListener('click', copyRoomLink);

            // Emoji picker
            const emojiPicker = document.getElementById('emoji-picker');
            EMOJIS.forEach(emoji => {
                const btn = document.createElement('button');
                btn.className = 'emoji-btn';
                btn.textContent = emoji;
                btn.onclick = () => addEmoji(emoji);
                emojiPicker.appendChild(btn);
            });

            // Emoji controls
            document.getElementById('clear-emoji-btn').addEventListener('click', clearEmoji);
            document.getElementById('submit-clue-btn').addEventListener('click', submitClue);

            // Chat
            document.getElementById('send-guess-btn').addEventListener('click', sendGuess);
            document.getElementById('chat-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendGuess();
            });

            // Play again
            document.getElementById('play-again-btn').addEventListener('click', playAgain);
        }

        function initializePeer() {
            updateStatus('Connecting...', 'connecting');
            
            // Check if joining existing room
            const urlParams = new URLSearchParams(window.location.search);
            const roomId = urlParams.get('room');

            if (roomId) {
                // Guest joining room
                isHost = false;
                peer = new Peer();
            } else {
                // Host creating room
                isHost = true;
                peer = new Peer();
            }

            peer.on('open', (id) => {
                peerId = id;
                console.log('Peer ID:', peerId);
                
                if (isHost) {
                    // Host: Display room link
                    const roomLink = `${window.location.origin}${window.location.pathname}?room=${id}`;
                    document.getElementById('room-link').textContent = roomLink;
                    document.getElementById('room-link-section').classList.remove('hidden');
                    document.getElementById('start-game-btn').classList.remove('hidden');
                    updateStatus('Connected - You are the host', 'connected');
                } else {
                    // Guest: Connect to host
                    connectToHost(roomId);
                }
            });

            peer.on('connection', (conn) => {
                handleConnection(conn);
            });

            peer.on('error', (err) => {
                console.error('Peer error:', err);
                updateStatus(`Error: ${err.type}`, 'error');
            });

            peer.on('disconnected', () => {
                updateStatus('Disconnected from network', 'error');
            });
        }

        // ============================================================================
        // CONNECTION MANAGEMENT
        // ============================================================================
        
        function connectToHost(hostId) {
            updateStatus('Connecting to host...', 'connecting');
            const conn = peer.connect(hostId);
            handleConnection(conn);
        }

        function handleConnection(conn) {
            conn.on('open', () => {
                console.log('Connection opened:', conn.peer);
                connections.set(conn.peer, conn);
                
                // Send player info
                if (playerName) {
                    sendMessage(conn, {
                        type: 'player-join',
                        player: {
                            id: peerId,
                            name: playerName,
                            score: 0,
                            isHost: isHost
                        }
                    });
                }
                
                updateStatus('Connected', 'connected');
            });

            conn.on('data', (data) => {
                handleMessage(conn, data);
            });

            conn.on('close', () => {
                console.log('Connection closed:', conn.peer);
                connections.delete(conn.peer);
                handlePlayerDisconnect(conn.peer);
            });

            conn.on('error', (err) => {
                console.error('Connection error:', err);
            });
        }

        function sendMessage(conn, message) {
            if (conn && conn.open) {
                conn.send(message);
            }
        }

        function broadcastMessage(message) {
            connections.forEach(conn => {
                sendMessage(conn, message);
            });
        }

        // ============================================================================
        // MESSAGE HANDLING
        // ============================================================================
        
        function handleMessage(conn, data) {
            console.log('Received message:', data.type, data);
            
            switch (data.type) {
                case 'player-join':
                    handlePlayerJoin(data.player);
                    break;
                case 'game-state':
                    handleGameStateUpdate(data.state);
                    break;
                case 'start-game':
                    handleGameStart(data.state);
                    break;
                case 'emoji-clue':
                    handleEmojiClue(data.clue);
                    break;
                case 'chat-message':
                    handleChatMessage(data);
                    break;
                case 'round-end':
                    handleRoundEnd(data);
                    break;
                case 'game-end':
                    handleGameEnd(data.state);
                    break;
                case 'play-again':
                    handlePlayAgain();
                    break;
                case 'player-disconnect':
                    handlePlayerDisconnect(data.playerId);
                    break;
            }
        }

        function handlePlayerJoin(player) {
            // Check if player already exists
            const existingPlayer = gameState.players.find(p => p.id === player.id);
            if (existingPlayer) {
                return;
            }

            // Add player
            gameState.players.push(player);
            updateLobbyPlayerList();
            
            // If host, send current game state to new player
            if (isHost) {
                const conn = connections.get(player.id);
                if (conn) {
                    sendMessage(conn, {
                        type: 'game-state',
                        state: gameState
                    });
                }
                
                // Notify all players
                broadcastMessage({
                    type: 'game-state',
                    state: gameState
                });
            }
            
            addSystemMessage(`${player.name} joined the game`);
        }

        function handleGameStateUpdate(state) {
            gameState = state;
            updateLobbyPlayerList();
            updateScoreDisplay();
        }

        function handleGameStart(state) {
            gameState = state;
            showGameScreen();
            startRound();
        }

        function handleEmojiClue(clue) {
            gameState.emojiClue = clue;
            document.getElementById('emoji-clue-display').textContent = clue || 'Waiting for clue...';
        }

        function handleChatMessage(data) {
            addChatMessage(data.playerName, data.message, data.isCorrect);
        }

        function handleRoundEnd(data) {
            gameState = data.state;
            showRoundResults(data.winner, data.phrase);
            
            // Start next round after delay
            setTimeout(() => {
                if (gameState.currentRound < gameState.maxRounds) {
                    startRound();
                } else {
                    endGame();
                }
            }, CONFIG.ROUND_DELAY);
        }

        function handleGameEnd(state) {
            gameState = state;
            showFinalLeaderboard();
        }

        function handlePlayAgain() {
            resetGame();
            showGameScreen();
            startRound();
        }

        function handlePlayerDisconnect(playerId) {
            const player = gameState.players.find(p => p.id === playerId);
            if (player) {
                addSystemMessage(`${player.name} disconnected`);
                gameState.players = gameState.players.filter(p => p.id !== playerId);
                updateLobbyPlayerList();
                updateScoreDisplay();
                
                // If host disconnected and game is running, handle gracefully
                if (player.isHost && gameState.gameStarted) {
                    // Elect new host
                    if (gameState.players.length > 0) {
                        gameState.players[0].isHost = true;
                        if (gameState.players[0].id === peerId) {
                            isHost = true;
                            addSystemMessage('You are now the host');
                        }
                    } else {
                        // No players left, reset
                        resetGame();
                        showLobbyScreen();
                    }
                }
            }
        }

        // ============================================================================
        // PLAYER MANAGEMENT
        // ============================================================================
        
        function setPlayerName() {
            const nameInput = document.getElementById('player-name');
            const name = nameInput.value.trim();
            
            if (!name) {
                alert('Please enter a name');
                return;
            }
            
            playerName = name;
            
            // Add self to players list
            const selfPlayer = {
                id: peerId,
                name: playerName,
                score: 0,
                isHost: isHost
            };
            
            gameState.players.push(selfPlayer);
            
            // Hide name input
            document.getElementById('name-input-section').classList.add('hidden');
            
            // Send to all connections
            broadcastMessage({
                type: 'player-join',
                player: selfPlayer
            });
            
            updateLobbyPlayerList();
            updateStartButton();
        }

        function updateLobbyPlayerList() {
            const listEl = document.getElementById('lobby-player-list');
            const countEl = document.getElementById('player-count');
            
            listEl.innerHTML = '';
            countEl.textContent = gameState.players.length;
            
            gameState.players.forEach(player => {
                const div = document.createElement('div');
                div.className = 'player-item';
                div.textContent = `${player.name}${player.isHost ? ' (Host)' : ''}`;
                listEl.appendChild(div);
            });
            
            updateStartButton();
        }

        function updateStartButton() {
            if (isHost) {
                const btn = document.getElementById('start-game-btn');
                const canStart = gameState.players.length >= CONFIG.MIN_PLAYERS;
                btn.disabled = !canStart;
                btn.textContent = canStart ? 'Start Game' : `Start Game (Need ${CONFIG.MIN_PLAYERS}+ players)`;
            }
        }

        // ============================================================================
        // GAME FLOW
        // ============================================================================
        
        function startGame() {
            if (!isHost) return;
            if (gameState.players.length < CONFIG.MIN_PLAYERS) {
                alert(`Need at least ${CONFIG.MIN_PLAYERS} players to start`);
                return;
            }
            
            gameState.gameStarted = true;
            gameState.currentRound = 0;
            
            // Reset scores
            gameState.players.forEach(p => p.score = 0);
            
            // Broadcast game start
            broadcastMessage({
                type: 'start-game',
                state: gameState
            });
            
            showGameScreen();
            startRound();
        }

        function startRound() {
            if (!isHost) return;
            
            gameState.currentRound++;
            gameState.roundInProgress = true;
            gameState.roundWinner = null;
            gameState.emojiClue = '';
            
            // Rotate describer
            const describerIndex = (gameState.currentRound - 1) % gameState.players.length;
            gameState.describerId = gameState.players[describerIndex].id;
            
            // Pick random phrase
            gameState.currentPhrase = PHRASES[Math.floor(Math.random() * PHRASES.length)];
            
            console.log(`Round ${gameState.currentRound}: Describer=${gameState.describerId}, Phrase=${gameState.currentPhrase}`);
            
            // Broadcast game state
            broadcastMessage({
                type: 'game-state',
                state: gameState
            });
            
            updateGameUI();
        }

        function submitClue() {
            if (gameState.describerId !== peerId) return;
            if (!localEmojiClue) {
                alert('Please add some emojis to your clue');
                return;
            }
            
            gameState.emojiClue = localEmojiClue;
            
            // Broadcast clue
            if (isHost) {
                broadcastMessage({
                    type: 'emoji-clue',
                    clue: localEmojiClue
                });
            } else {
                // Send to host
                connections.forEach(conn => {
                    sendMessage(conn, {
                        type: 'emoji-clue',
                        clue: localEmojiClue
                    });
                });
            }
            
            updateGameUI();
            addSystemMessage(`${playerName} submitted a clue!`);
        }

        function sendGuess() {
            const input = document.getElementById('chat-input');
            const guess = input.value.trim();
            
            if (!guess) return;
            if (!gameState.roundInProgress) return;
            if (gameState.describerId === peerId) return; // Describer can't guess
            
            input.value = '';
            
            // Check if guess is correct
            const isCorrect = checkGuess(guess, gameState.currentPhrase);
            
            const message = {
                type: 'chat-message',
                playerId: peerId,
                playerName: playerName,
                message: guess,
                isCorrect: isCorrect,
                timestamp: Date.now()
            };
            
            // Add to local chat
            addChatMessage(playerName, guess, isCorrect);
            
            // Send to all
            if (isHost) {
                broadcastMessage(message);
                
                // Handle correct guess
                if (isCorrect && !gameState.roundWinner) {
                    handleCorrectGuess(peerId, playerName);
                }
            } else {
                // Send to host for validation
                connections.forEach(conn => {
                    sendMessage(conn, message);
                });
            }
        }

        function checkGuess(guess, phrase) {
            // Normalize strings: lowercase, remove special chars
            const normalizeStr = (str) => {
                return str.toLowerCase()
                    .replace(/[^a-z0-9\s]/g, '')
                    .replace(/\s+/g, ' ')
                    .trim();
            };
            
            const normalizedGuess = normalizeStr(guess);
            const normalizedPhrase = normalizeStr(phrase);
            
            return normalizedGuess === normalizedPhrase;
        }

        function handleCorrectGuess(winnerId, winnerName) {
            if (!isHost) return;
            if (gameState.roundWinner) return; // Already has winner
            
            gameState.roundWinner = winnerId;
            gameState.roundInProgress = false;
            
            // Award points
            const winner = gameState.players.find(p => p.id === winnerId);
            const describer = gameState.players.find(p => p.id === gameState.describerId);
            
            if (winner) winner.score += CONFIG.POINTS_CORRECT_GUESS;
            if (describer) describer.score += CONFIG.POINTS_DESCRIBER;
            
            // Broadcast round end
            broadcastMessage({
                type: 'round-end',
                state: gameState,
                winner: winnerName,
                phrase: gameState.currentPhrase
            });
            
            showRoundResults(winnerName, gameState.currentPhrase);
            
            // Start next round after delay
            setTimeout(() => {
                if (gameState.currentRound < gameState.maxRounds) {
                    startRound();
                } else {
                    endGame();
                }
            }, CONFIG.ROUND_DELAY);
        }

        function endGame() {
            if (!isHost) return;
            
            gameState.gameStarted = false;
            
            // Broadcast game end
            broadcastMessage({
                type: 'game-end',
                state: gameState
            });
            
            showFinalLeaderboard();
        }

        function playAgain() {
            if (!isHost) return;
            
            resetGame();
            
            broadcastMessage({
                type: 'play-again'
            });
            
            showGameScreen();
            startRound();
        }

        function resetGame() {
            gameState.currentRound = 0;
            gameState.gameStarted = true;
            gameState.roundInProgress = false;
            gameState.roundWinner = null;
            gameState.describerId = null;
            gameState.currentPhrase = '';
            gameState.emojiClue = '';
            gameState.players.forEach(p => p.score = 0);
            
            localEmojiClue = '';
            document.getElementById('emoji-preview').textContent = '';
            document.getElementById('chat-messages').innerHTML = '';
        }

        // ============================================================================
        // EMOJI PICKER
        // ============================================================================
        
        function addEmoji(emoji) {
            localEmojiClue += emoji;
            document.getElementById('emoji-preview').textContent = localEmojiClue;
        }

        function clearEmoji() {
            localEmojiClue = '';
            document.getElementById('emoji-preview').textContent = '';
        }

        // ============================================================================
        // CHAT
        // ============================================================================
        
        function addChatMessage(name, message, isCorrect = false) {
            const chatEl = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = `chat-message${isCorrect ? ' correct' : ''}`;
            div.textContent = `${name}: ${message}`;
            chatEl.appendChild(div);
            chatEl.scrollTop = chatEl.scrollHeight;
        }

        function addSystemMessage(message) {
            const chatEl = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = 'chat-message system';
            div.textContent = `[${message}]`;
            chatEl.appendChild(div);
            chatEl.scrollTop = chatEl.scrollHeight;
        }

        // ============================================================================
        // UI UPDATES
        // ============================================================================
        
        function updateStatus(text, status) {
            const statusEl = document.getElementById('connection-status');
            const textEl = document.getElementById('status-text');
            
            statusEl.className = `connection-status status-${status}`;
            textEl.textContent = text;
        }

        function showLobbyScreen() {
            document.getElementById('lobby-screen').classList.remove('hidden');
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('round-results').classList.add('hidden');
            document.getElementById('final-leaderboard').classList.add('hidden');
        }

        function showGameScreen() {
            document.getElementById('lobby-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            document.getElementById('round-results').classList.add('hidden');
            document.getElementById('final-leaderboard').classList.add('hidden');
            
            updateGameUI();
        }

        function updateGameUI() {
            // Update round info
            document.getElementById('current-round').textContent = gameState.currentRound;
            document.getElementById('max-rounds').textContent = gameState.maxRounds;
            
            // Update describer name
            const describer = gameState.players.find(p => p.id === gameState.describerId);
            document.getElementById('current-describer-name').textContent = describer ? describer.name : '-';
            
            // Show appropriate view
            const isDescriber = gameState.describerId === peerId;
            document.getElementById('describer-view').classList.toggle('hidden', !isDescriber);
            document.getElementById('guesser-view').classList.toggle('hidden', isDescriber || !gameState.roundInProgress);
            document.getElementById('waiting-view').classList.toggle('hidden', gameState.roundInProgress);
            
            // Update describer view
            if (isDescriber) {
                document.getElementById('secret-phrase-text').textContent = gameState.currentPhrase;
            }
            
            // Update guesser view
            document.getElementById('emoji-clue-display').textContent = gameState.emojiClue || 'Waiting for clue...';
            
            // Update scores
            updateScoreDisplay();
            
            // Disable chat input for describer
            document.getElementById('chat-input').disabled = isDescriber;
            document.getElementById('send-guess-btn').disabled = isDescriber;
        }

        function updateScoreDisplay() {
            const scoreEl = document.getElementById('score-list');
            scoreEl.innerHTML = '';
            
            // Sort by score
            const sortedPlayers = [...gameState.players].sort((a, b) => b.score - a.score);
            
            sortedPlayers.forEach(player => {
                const div = document.createElement('div');
                div.className = 'score-item';
                if (player.id === gameState.describerId) {
                    div.classList.add('current-describer');
                }
                
                const name = document.createElement('span');
                name.textContent = player.name;
                
                const score = document.createElement('span');
                score.textContent = player.score;
                
                div.appendChild(name);
                div.appendChild(score);
                scoreEl.appendChild(div);
            });
        }

        function showRoundResults(winnerName, phrase) {
            const resultsEl = document.getElementById('round-results');
            const contentEl = document.getElementById('results-content');
            
            contentEl.innerHTML = `
                <div class="winner-announcement">🎉 ${winnerName} guessed correctly!</div>
                <p><strong>The answer was:</strong> ${phrase}</p>
                <p><strong>Emoji clue:</strong> ${gameState.emojiClue}</p>
            `;
            
            resultsEl.classList.remove('hidden');
            
            setTimeout(() => {
                resultsEl.classList.add('hidden');
            }, CONFIG.ROUND_DELAY - 500);
        }

        function showFinalLeaderboard() {
            document.getElementById('lobby-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('round-results').classList.add('hidden');
            document.getElementById('final-leaderboard').classList.remove('hidden');
            
            // Show play again button only to host
            document.getElementById('play-again-btn').classList.toggle('hidden', !isHost);
            
            const scoresEl = document.getElementById('final-scores');
            scoresEl.innerHTML = '';
            
            // Sort by score
            const sortedPlayers = [...gameState.players].sort((a, b) => b.score - a.score);
            
            sortedPlayers.forEach((player, index) => {
                const div = document.createElement('div');
                div.className = 'leaderboard-item';
                
                const position = document.createElement('span');
                position.textContent = `#${index + 1} ${player.name}`;
                
                const score = document.createElement('span');
                score.textContent = `${player.score} points`;
                
                div.appendChild(position);
                div.appendChild(score);
                scoresEl.appendChild(div);
            });
        }

        function copyRoomLink() {
            const linkEl = document.getElementById('room-link');
            const link = linkEl.textContent;
            
            navigator.clipboard.writeText(link).then(() => {
                const btn = document.getElementById('copy-link-btn');
                const originalText = btn.textContent;
                btn.textContent = 'Copied!';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
                alert('Failed to copy link. Please copy manually.');
            });
        }
    </script>
</body>
</html>